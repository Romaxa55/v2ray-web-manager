## Некоторая теория, некоторые компромиссы

### Глобальное количество соединений - теория дизайна
> *CAP* и *BASE* - это две ключевые теории в распределенных системах.

`Глобальное количество соединений` построено на основе этих двух теорий. При необходимости обеспечить `производительность и отказоустойчивость`, P определено. C (согласованность) и A (доступность) находятся в отношениях взаимного исключения, можно выбрать только одно из них.

В текущей среде многие развертывания происходят через дата-центры, через страны, где задержка между странами составляет более 150 мс. Если нужно обеспечить C (согласованность), это значительно снизит производительность proxy-конца, поэтому обеспечение согласованности (C) неприемлемо.

Таким образом, дизайн `Глобального количества соединений` основан на AP. Какие проблемы это может вызвать? Да, проблемы `согласованности` (разные значения, полученные на разных машинах).

Поскольку мы делаем компромисс по `согласованности`, возникает вопрос, будет ли наши данные путаться и т. д. Насколько мы готовы идти на компромисс, это требует объяснения с помощью теории `BASE`.

Основная идея теории `BASE`: если невозможно достичь строгой согласованности, то, исходя из особенностей бизнеса, используйте подходящий способ, чтобы система достигла конечной согласованности.

В заключение: Глобальное количество соединений = Теория AP + BASE (разрешено промежуточное состояние, но в конечном итоге достигается согласованность).

### Основная теория реализации на стороне proxy

- Основано на прямой памяти - [Источник](https://blog.csdn.net/qq_38410730/article/details/81105132)
    - Данные не нужно копировать из ядра (kernel) в пользовательское пространство процесса, что уменьшает I/O.
    - Общий доступ к данным, другие процессы, программы или сетевые выходы могут напрямую работать на основе буфера ядра, 0 копирования.
- NIO
    - Может обрабатывать миллионы запросов без проблем, маленькое использование памяти.
- Асинхронность
    - Почти все операции асинхронны, рабочий поток не блокируется.
- Блокировка
    - Нет блокировок на уровне объекта/класса, в основном это блокировки сегментов/оптимистические блокировки.
- soft/weakReference
    - Кэширование и блокировка основаны на их реализации, быстрое удаление мусора.

### Адаптация к протоколу v2ray

v2ray поддерживает множество протоколов, таких как: HTTP2, TCP, MKCP... Причины не адаптировать эти протоколы:

  - Анализ протокола передачи требует затрат.
  - Эти протоколы очень специфичны, кроме HTTP2 и WS.
    - Немногие компании их используют (по сравнению с HTTP), их характеристики слишком очевидны. Те, кто знает немного о машинном обучении, знают, что чем более очевидна характеристика, тем выше точность.
    - Даже если ваш пакет данных зашифрован с помощью тысячи алгоритмов шифрования, это бесполезно.
  - HTTP2 и WS оба построены на основе HTTP, оба являются дополнением к HTTP для долгосрочных соединений и многократного использования. HTTP2 лучше подходит для некоторых веб-сценариев.
